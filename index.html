<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Strobe Light</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: black;
      transition: background-color 0.05s;
      font-family: sans-serif;
    }

    #settingsToggle {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      z-index: 10;
    }

    #settingsPanel {
      position: absolute;
      top: 50px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 1em;
      border-radius: 8px;
      display: none;
      z-index: 10;
      text-align: center;
    }

    input[type="number"] {
      width: 80px;
      margin-top: 0.5em;
      padding: 4px;
    }

    button {
      margin-top: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <button id="settingsToggle">‚öôÔ∏è Settings</button>

  <div id="settingsPanel">
    <label for="bpmInput">BPM:</label><br>
    <input type="number" id="bpmInput" value="120" min="30" max="300" /><br>
    <button id="modeToggle">Switch to Sound Mode</button><br>
    <button id="syncBtn">üîÑ Sync</button>
  </div>

  <script>
    let bpm = 120;
    let interval = (60 / bpm) * 1000;
    let strobeInterval;
    let isSoundMode = false;
    let on = false;

    const bpmInput = document.getElementById("bpmInput");
    const modeToggle = document.getElementById("modeToggle");
    const settingsToggle = document.getElementById("settingsToggle");
    const settingsPanel = document.getElementById("settingsPanel");
    const syncBtn = document.getElementById("syncBtn");

    settingsToggle.addEventListener("click", () => {
      settingsPanel.style.display = settingsPanel.style.display === "block" ? "none" : "block";
    });

    function startBPMStrobe() {
      clearInterval(strobeInterval);
      strobeInterval = setInterval(() => {
        document.body.style.backgroundColor = on ? "black" : "white";
        on = !on;
      }, interval);
    }

    bpmInput.addEventListener("input", () => {
      const val = parseInt(bpmInput.value);
      if (!isNaN(val) && val > 0) {
        bpm = val;
        interval = (60 / bpm) * 1000;
        if (!isSoundMode) startBPMStrobe();
      }
    });

    modeToggle.addEventListener("click", () => {
      isSoundMode = !isSoundMode;
      modeToggle.textContent = isSoundMode ? "Switch to BPM Mode" : "Switch to Sound Mode";

      if (isSoundMode) {
        clearInterval(strobeInterval);
        startSoundReactive();
      } else {
        startBPMStrobe();
      }
    });

    syncBtn.addEventListener("click", () => {
      if (!isSoundMode) {
        on = false; // force reset to black
        document.body.style.backgroundColor = "black";
        startBPMStrobe();
      }
    });

    function startSoundReactive() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;

        const bufferLength = analyser.fftSize;
        const dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);

        function animate() {
          analyser.getByteTimeDomainData(dataArray);
          let sumSquares = 0;
          for (let i = 0; i < bufferLength; i++) {
            const normalized = (dataArray[i] - 128) / 128;
            sumSquares += normalized * normalized;
          }
          const rms = Math.sqrt(sumSquares / bufferLength);

          if (rms > 0.1) {
            document.body.style.backgroundColor = 'white';
            setTimeout(() => {
              document.body.style.backgroundColor = 'black';
            }, 50);
          }

          if (isSoundMode) requestAnimationFrame(animate);
        }

        animate();
      }).catch(err => {
        alert('Microphone access denied or not available.');
        console.error(err);
        isSoundMode = false;
        modeToggle.textContent = "Switch to Sound Mode";
        startBPMStrobe();
      });
    }

    // Start with BPM mode
    startBPMStrobe();
  </script>
</body>
</html>
