<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Strobe Light</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      min-height: 100vh;
      background-color: black;
      transition: background-color 0.05s;
      display: block;
    }
    #controls {
      position: absolute;
      top: 20px;
      text-align: center;
    }
    input[type=range] {
      width: 200px;
    }
    button {
      margin-top: 10px;
      padding: 0.5em 1em;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div>
      <label>BPM: <span id="bpmDisplay">120</span></label><br>
      <input type="range" id="bpmSlider" min="30" max="1000" value="120">
    </div>
    <button id="modeToggle">Switch to Sound Mode</button>
  </div>

  <script>
    let bpm = 120;
    let interval = 500; // ms, initially set from BPM
    let strobeInterval;
    let isSoundMode = false;
    let on = false;

    const bpmSlider = document.getElementById("bpmSlider");
    const bpmDisplay = document.getElementById("bpmDisplay");
    const modeToggle = document.getElementById("modeToggle");

    function startBPMStrobe() {
      clearInterval(strobeInterval);
      strobeInterval = setInterval(() => {
        document.body.style.backgroundColor = on ? "black" : "white";
        on = !on;
      }, interval);
    }

    bpmSlider.addEventListener("input", () => {
      bpm = parseInt(bpmSlider.value);
      bpmDisplay.textContent = bpm;
      interval = (60 / bpm) * 1000;
      if (!isSoundMode) startBPMStrobe();
    });

    modeToggle.addEventListener("click", () => {
      isSoundMode = !isSoundMode;
      modeToggle.textContent = isSoundMode ? "Switch to BPM Mode" : "Switch to Sound Mode";

      if (isSoundMode) {
        clearInterval(strobeInterval);
        startSoundReactive();
      } else {
        startBPMStrobe();
      }
    });

    function startSoundReactive() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        const context = new (window.AudioContext || window.webkitAudioContext)();
        const source = context.createMediaStreamSource(stream);
        const analyser = context.createAnalyser();
        source.connect(analyser);
        analyser.fftSize = 256;

        const data = new Uint8Array(analyser.fftSize);

        function detectSound() {
          analyser.getByteTimeDomainData(data);
          let total = 0;
          for (let i = 0; i < data.length; i++) {
            const val = (data[i] - 128) / 128;
            total += val * val;
          }
          const rms = Math.sqrt(total / data.length);
          if (rms > 0.1) {
            document.body.style.backgroundColor = "white";
            setTimeout(() => {
              document.body.style.backgroundColor = "black";
            }, 50);
          }
          if (isSoundMode) requestAnimationFrame(detectSound);
        }

        detectSound();
      }).catch(err => {
        alert("Mic access denied or not available.");
        isSoundMode = false;
        modeToggle.textContent = "Switch to Sound Mode";
        startBPMStrobe();
      });
    }

    // Initial start
    interval = (60 / bpm) * 1000;
    startBPMStrobe();
  </script>
</body>
</html>
